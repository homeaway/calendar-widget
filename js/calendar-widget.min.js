/* Copyright (c) 2010 HomeAway, Inc.
* All rights reserved.  http://homeaway.github.io/calendar-widget/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(function(){var e=window.jQuery,t=window.Backbone,a=window._,r=function(r){this.Model=t.Model.extend({initialize:function(){var t=this.get("defaultDate"),r=this.getCalendar();a.bindAll(this,"addReservations","removeReservations","resolveDateConflicts","formatDate","getDefaultDates","copyDate","makeDate","resolveDates","getCalendar","setDataBounds","throwError","reverseFormatDate","getReservationsById"),r=e.merge(r,this.getDefaultDates()),this.set("calendar",r),t?this.setDataBounds(this.reverseFormatDate(t)):this.setDataBounds(new Date)},addReservations:function(t){t.calendar&&t.reservations||this.throwError("addReservations() requires calendar and reservations data");var a=this.getCalendar(),r=this.resolveDates(e.extend(!0,{},t.calendar),e.extend(!0,{},t.reservations));this.set("calendar",e.merge(a,r))},getCalendar:function(){return e.extend(!0,[],this.get("calendar"))},throwError:function(e){throw e},removeReservations:function(e){var t,a,r=this.getCalendar();for(e||this.throwError("removeReservations requires an array of reservation ids or a single reservation id as a string"),"string"==typeof e&&(e=[e]),t=e.length-1;t>=0;t--)for(e[t]=e[t].toLowerCase(),a=r.length-1;a>=0;a--)r[a].reservationId===e[t]&&r.splice(a,1);this.set("calendar",r)},copyDate:function(e){return new Date(e.getTime())},makeDate:function(e,t){return e=e?this.copyDate(e):new Date,t&&t.months&&e.setMonth(e.getMonth()+t.months),t&&t.days&&e.setDate(e.getDate()+t.days),e},setDataBounds:function(e){return this.set({endDate:this.formatDate(this.makeDate(e,{months:12})),startDate:this.formatDate(this.makeDate(e,{months:-12})),defaultDate:this.formatDate(e)}),!1},defaults:{calendar:[],startCalendarDate:void 0,endCalendarDate:void 0},parse:function(t){return t.calendar=this.resolveDates(t.calendar,t.reservations),t.calendar=e.merge(this.getDefaultDates(),t.calendar),t},resolveDates:function(t,a){function r(e,t){return{startDate:t?t.startDate:e.startDate?e.startDate:void 0,endDate:t?t.endDate:e.endDate?e.endDate:void 0,date:e.date,reservationId:e.reservationId,duration:(e.duration?e.duration:void 0)||(t.checkinDate===e.date?"pm":void 0)||(t.checkoutDate===e.date?"am":"full"),status:(t?t.status?t.status.toLowerCase():void 0:void 0)||(e?e.status?e.status.toLowerCase():"":""),guestFirstName:t?t.guestFirstName:void 0,guestLastName:t?t.guestLastName:void 0,checkinTime:t?t.checkinTime:void 0,checkoutTime:t?t.checkoutTime:void 0}}var n,s,i,o=[];for(n in t)if(s=a?a[t[n].reservationId]:void 0,t[n].startDate&&t[n].endDate){var d,l=t[n].endDate,h=t[n].startDate,u=t[n].status,c=this.makeDate(this.reverseFormatDate(l)),m=this.makeDate(this.reverseFormatDate(h)),v=t[n].reservationId,D=m;for(o.push(r({date:h,duration:"pm",reservationId:v,startDate:h,endDate:l,status:u},s)),d=Math.round(Math.abs((c-m)/864e5)),D=m,i=d-1;i>=1;i--)D.setDate(D.getDate()+1),o.push(r({date:this.formatDate(D),duration:"full",reservationId:v,startDate:h,endDate:l,status:u},s));o.push(r({date:l,duration:"am",reservationId:v,startDate:h,endDate:l,status:u},s)),delete a[t[n].reservationId]}else o.push(r(e.extend(!0,{date:n},t[n]),s));for(n in a)o.push(r({date:a[n].checkoutDate,reservationId:n},a[n]));return this.resolveDateConflicts(o)},resolveDateConflicts:function(e){for(i=e.length-1;i>=0;i--)for(j=e.length-1;j>=0;j--)if(i!==j&&e[i].date===e[j].date&&e[i].startDate&&e[i].endDate){if("full"===e[i].duration&&"full"===e[j].duration){this.reverseFormatDate(e[i].startDate)>this.reverseFormatDate(e[j].startDate)?e.splice(j,1):this.reverseFormatDate(e[i].startDate)<this.reverseFormatDate(e[j].startDate)?e.splice(i,1):this.reverseFormatDate(e[i].endDate)>this.reverseFormatDate(e[j].endDate)?e.splice(i,1):this.reverseFormatDate(e[i].endDate)<this.reverseFormatDate(e[j].endDate)?e.splice(j,1):"reserve"===e[i].status?e.splice(j,1):e.splice(i,1);break}if("pm"===e[i].duration&&"full"===e[j].duration){e[j].duration="am";break}if("am"===e[i].duration&&"full"===e[j].duration){e[j].duration="pm";break}if("am"===e[i].duration&&"am"===e[j].duration){this.reverseFormatDate(e[i].endDate)>this.reverseFormatDate(e[j].endDate)?e.splice(i,1):this.reverseFormatDate(e[i].endDate)<this.reverseFormatDate(e[j].endDate)?e.splice(j,1):"reserve"===e[i].status?e.splice(j,1):e.splice(i,1);break}"pm"===e[i].duration&&"pm"===e[j].duration&&(this.reverseFormatDate(e[i].startDate)>this.reverseFormatDate(e[j].startDate)?e.splice(j,1):this.reverseFormatDate(e[i].startDate)<this.reverseFormatDate(e[j].startDate)?e.splice(i,1):"reserve"===e[i].status?e.splice(j,1):e.splice(i,1))}return e},getDefaultDates:function(){return this.resolveDates(e.extend(!0,{},this.get("defaultCalendar")),e.extend(!0,{},this.get("defaultCalendarEvents")))},getReservationsById:function(e){return a.where(this.getCalendar(),{reservationId:e})},formatDate:function(e){var t=""+e.getDate(),a=""+(e.getMonth()+1);return""+e.getFullYear()+"-"+(a[1]?a:"0"+a[0])+"-"+(t[1]?t:"0"+t[0])},reverseFormatDate:function(e){var t=e.split("-");return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10))},url:function(){return this.get("url")+this.get("propertyId")+"?startDate="+this.get("startDate")+"&endDate="+this.get("endDate")}}),e.datepicker._updateDatepicker.modified||(e.datepicker._updateDatepicker_original=e.datepicker._updateDatepicker,e.datepicker._updateDatepicker=function(t){e.datepicker._updateDatepicker_original(t);var a=this._get(t,"afterShow");a&&a.apply(t.input?t.input[0]:null)},e.datepicker._updateDatepicker.modified=!0),this.View=t.View.extend({initialize:function(r){var n=this;a.bindAll(this,"fetchData","extendOptionsFunction");for(var s in r.clicked)this.extendOptionsFunction(s,r.clicked);e.extend(!0,this,{clicked:r.clicked,hovered:r.hovered,error:r.error,endCalendar:r.endCalendar,hoverClass:r.hoverClass,hoverClassStart:r.hoverClassStart,hoverClassEnd:r.hoverClassEnd,fetching:r.fetch,currentElement:void 0}),t.Layout||(a.bindAll(this,"afterRender"),this.on("render",this.afterRender,this)),this.model.on("error",function(e){n.$el.trigger("error",e),n.error(e)}),this.model.on("change:calendar",this.afterRender,this),this.model.on("change:startDate",function(){n.fetchData(r.fetch)}),this.fetchData(r.fetch)},extendOptionsFunction:function(e,t){var a=this,r=t[e];t[e]=function(t,n){a.$el.trigger(e,[t,n]),r.call(this,t,n)}},fetchData:function(e){var t=this;return this.fetching=e,this.afterRender(),this.model.get("propertyId")&&this.fetching&&this.model.fetch({complete:function(){t.fetching=!1,t.afterRender()}}),!1},createCalendar:function(t){var a=t.el,r=t.isEndCalendar,n=t.endCalendar,s=t.startCalendar,i=e.extend(!0,[],this.model.get("calendar")),o=this,d=this.model.reverseFormatDate(this.model.get("defaultDate"));this.model.get("locale");var l;a.datepicker("destroy").datepicker({minDate:this.model.get("minDate"),maxDate:this.model.get("maxDate"),defaultDate:d,firstDay:this.model.get("startOfWeek"),showButtonPanel:this.model.get("showButtonPanel"),numberOfMonths:this.model.get("numberOfMonths"),beforeShowDay:function(e){var t,a,s,d=o.model.get("startCalendarDate"),l=o.model.get("endCalendarDate"),h=o.model.hoveredEndDate,u=o.model.hoveredStartDate,c=[];for(e=o.model.formatDate(e),a=i.length-1;a>-1;a--)i[a].date===e&&c.push(" "+i[a].duration+"-"+i[a].status.toLowerCase()+" X"+i[a].reservationId+"X");return 2===c.length&&-1!==c[0].indexOf("pm-")&&c[1].indexOf("am-")&&(s=c[0],c[0]=c[1],c[1]=s),t=o.model.reverseFormatDate(e),n?l>t&&t>d||d>t&&t>u||d&&l&&""+d==""+t&&""+l==""+d||d&&u&&d>u&&""+d==""+t?c.push(" "+o.hoverClass):d&&""+d==""+t||u&&""+u==""+t?c.push(" "+o.hoverClassStart):l&&""+l==""+t&&c.push(" "+o.hoverClassEnd):r&&(h>d&&t>d&&h>t||l&&t>d&&l>t||d&&l&&""+d==""+t&&""+l==""+d?c.push(" "+o.hoverClass):d&&""+d==""+t?c.push(" "+o.hoverClassStart):(l&&""+t==""+l||h&&""+t==""+h)&&c.push(" "+o.hoverClassEnd)),[!0,c.join(""),""]},onChangeMonthYear:function(e,t){if(o.fetching){var a,r,n=o.model.reverseFormatDate(o.model.get("startDate")),s=o.model.reverseFormatDate(o.model.get("endDate")),i=o.model.get("numberOfMonths"),d=i,l=0,h=0,u=new Date(e,t-1,1);if("[object Array]"===Object.prototype.toString.call(i))for(d=0,r=i.length-1;r>=0;r--)d+=i[r];l=12*(u.getFullYear()-n.getFullYear()),l-=n.getMonth()+1,l+=u.getMonth(),a=new Date(u.setMonth(u.getMonth()+d-2)),h=12*(s.getFullYear()-a.getFullYear()),h-=a.getMonth()+1,h+=s.getMonth(),(1>h||1>l)&&o.model.setDataBounds(new Date(e,t-1,1))}return!1},afterShow:function(){function t(e){return-1!==e.indexOf("reserve")?"reserve":-1!==e.indexOf("hold")?"hold":-1!==e.indexOf("delete")?"delete":-1!==e.indexOf("cancel")?"cancel":-1!==e.indexOf("unavailable")?"unavailable":-1!==e.indexOf("inquiry")?"inquiry":""}function n(t,r,n){if("inquiry"!==n){var s,i,o,d,l;if(i=a.find(".X"+t+"X"),r)for(l=i.length-1;l>=0;l--)s=e(i[l]),d=s.attr("class").split("X"),d[1]===t?(d[0]=d[0].replace("full-"+n,"full-"+n+"-hover"),d[0]=d[0].replace("am-"+n,"am-"+n+"-hover"),d[0]=d[0].replace("pm-"+n,"pm-"+n+"-hover")):(d[2]=d[2].replace("full-"+n,"full-"+n+"-hover"),d[2]=d[2].replace("am-"+n,"am-"+n+"-hover"),d[2]=d[2].replace("pm-"+n,"pm-"+n+"-hover")),s.attr("class",d.join("X"));else for(l=i.length-1;l>=0;l--)s=e(i[l]).unbind("mousemove"),o=s.attr("class"),o=o.replace(/-hover/g,""),s.attr("class",o)}}e(".ui-state-default").hover(function(){var s,i,d,h,u,c,m=e(this).parent(),v=m.attr("class"),D=v.split("X"),f=o.model.hoveredEndDate,g=o.model.hoveredStartDate,p=m.attr("onclick"),C=e(this).html();o.currentElement=e(this),-1!==v.indexOf("X")&&(s=D[1],D.length-1>3?e(this).unbind("mousemove").mousemove(function(a){var r=e(this).parent().offset(),d=a.pageX-r.left,h=a.pageY-r.top,u=e(this).parent().width()/2;n(s,!1,i),n(D[3],!1,i),u>d&&u>h?(i=t(D[0]),s=D[1],"inquiry"===i&&(i=D[2],s=D[3])):(i=t(D[2]),s=D[3],"inquiry"===i&&(i=D[0],s=D[1])),l!==s&&(o.currentElement=e(this),o.hovered.on(e(this),o.model.getReservationsById(s))),l=s,i=t(i),n(s,!0,i)}):(l=s,i=t(v),n(s,!0,i)),o.currentElement=e(this),o.hovered.on(e(this),o.model.getReservationsById(s))),"selectDay"===m.data("handler")?(h=parseInt(m.data("year"),10),u=parseInt(m.data("month"),10)+1):p&&(d=p.split(","),h=parseInt(d[2],10),u=parseInt(d[1],10)+1),h&&u&&(c=o.model.reverseFormatDate(h+"-"+u+"-"+C),!r||f&&""+f==""+c?g&&""+g==""+c||(o.model.hoveredStartDate=c,a.datepicker("refresh")):(o.model.hoveredEndDate=c,a.datepicker("refresh")))},function(){var t=e(this).parent().attr("class"),a=t.split("X"),r=a[1];a.length-1>3&&(n(a[3],!1,""),o.currentElement=e(this),o.hovered.off(e(this),o.model.getReservationsById(r))),r&&(n(r,!1,""),o.currentElement=e(this),o.hovered.off(e(this),o.model.getReservationsById(r)))})},onSelect:function(e,t){var d,h,u,c=o.model.get("startCalendarDate"),m=o.model.get("endCalendarDate"),v=e.split("/"),D=v[2]+"-"+v[0]+"-"+v[1],f=o.model.get("startIsEndMinimum");for(t.inline=!1,d=i.length-1;d>=0;d--)i[d].date===D&&i[d].reservationId===l&&(u=!0,o.clicked[i[d].status.toLowerCase()]?o.clicked[i[d].status.toLowerCase()](o.currentElement,i[d]):r?s.trigger(i[d].status.toLowerCase(),o.currentElement,i[d]):a.trigger(i[d].status.toLowerCase(),o.currentElement,i[d]));u||o.clicked.available(o.currentElement,D),r?(newSelectedEndDate=o.model.reverseFormatDate(D),m&&""+newSelectedEndDate==""+m||a.trigger("changed"),m=newSelectedEndDate,o.model.set("endCalendarDate",m)):(h=o.model.reverseFormatDate(D),c&&""+h==""+c||a.trigger("changed"),c=h,f&&n.datepicker("option","minDate",c),n&&o.model.set("startCalendarDate",c))},onClose:function(){var e=o.model.get("startCalendarDate"),t=o.model.get("endCalendarDate");o.model.hoveredEndDate,o.model.hoveredStartDate,o.model.hoveredStartDate=void 0,o.model.hoveredEndDate=void 0,n&&(a.datepicker("refresh").trigger("blur"),e&&(e>t||!t)&&(t=new Date(e.getTime()),t.setDate(t.getDate()+1),o.model.set("endCalendarDate",t),n.datepicker("setDate",t),n.trigger("changed"))),r&&(a.datepicker("refresh").trigger("blur"),(!e||e>t)&&(e=new Date(t.getTime()-1),o.model.set("startCalendarDate",e),s.datepicker("setDate",e),s.trigger("changed")))}})},afterRender:function(){var t=this.model.get("startCalendarDate"),a=this.model.get("endCalendarDate"),r=this;return this.createCalendar({el:this.$el,isEndCalendar:!1,endCalendar:this.endCalendar?e(this.endCalendar):void 0,startCalendar:void 0}),t&&this.$el.datepicker("setDate",t),this.endCalendar&&(e(this.endCalendar).on("click",function(){r.model.get("startCalendarDate")||(e(this).trigger("blur"),r.$el.trigger("focus"))}),this.createCalendar({el:e(this.endCalendar),isEndCalendar:!0,endCalendar:void 0,startCalendar:this.$el}),a&&e(this.endCalendar).datepicker("setDate",a)),"INPUT"!==this.el.tagName&&this.$el.append('<div class="calendar-loading" style="width: '+this.$el.width()+"px; height: "+this.$el.height()+"px; display:"+(this.fetching?"block":"none")+';"></div>'),this}}),r.language&&(e.datepicker.regional.custom={closeText:r.language.closeText,prevText:r.language.previous,nextText:r.language.next,currentText:r.language.currentText,monthNames:r.language.monthNames,monthNamesShort:r.language.monthNamesShort,dayNames:r.language.dayNames,dayNamesShort:r.language.dayNamesShort,dayNamesMin:r.language.dayNamesMin,weekHeader:r.language.weekHeader,dateFormat:"mm/dd/yy",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},e.datepicker.setDefaults(e.datepicker.regional.custom)),r=e.extend(!0,{},e.fn.calendar.defaults,r),this.model=this.model||new this.Model({defaultDate:r.defaultDate,numberOfMonths:r.numberOfMonths,propertyId:r.propertyId,defaultCalendar:r.calendar,defaultCalendarEvents:r.reservations,url:r.url,startOfWeek:r.startOfWeek,minDate:r.minDate,maxDate:r.maxDate,startCalendarDate:r.startCalendarDate,endCalendarDate:r.endCalendarDate,startIsEndMinimum:r.startIsEndMinimum,showButtonPanel:r.showButtonPanel}),this.view=this.view||new this.View({el:r.el,model:this.model,clicked:r.clicked,error:r.error,fetch:r.fetch,hovered:r.hovered,endCalendar:r.endCalendar,hoverClass:r.hoverClass,hoverClassStart:r.hoverClassStart,hoverClassEnd:r.hoverClassEnd}),this.addReservations=function(e){this.model.addReservations(e)},this.removeReservations=function(e){this.model.removeReservations(e)}},n=e.fn.calendar;e.fn.calendar=function(t,a){return this.each(function(){var n=e(this),s=n.data("calendar"),i="object"==typeof t&&t;i||(i={}),i.el=n,s||n.data("calendar",s=new r(i)),"string"==typeof t&&s[t](a)})},e.fn.calendar.Constructor=r,e.fn.calendar.noConflict=function(){return e.fn.calendar=n,this},e.fn.calendar.defaults={endCalendar:void 0,hoverClass:"",hoverClassStart:"",hoverClassEnd:"",startOfWeek:0,defaultDate:void 0,endDate:void 0,startDate:void 0,propertyId:void 0,numberOfMonths:1,fetch:!0,minDate:void 0,maxDate:void 0,startCalendarDate:void 0,endCalendarDate:void 0,startIsEndMinimum:!1,showButtonPanel:!1,calendar:{},reservations:{},clicked:{inquiry:function(){},available:function(){},unavailable:function(){},hold:function(){},reserve:function(){},"delete":function(){}},hovered:{on:function(){},off:function(){}},error:function(){},url:"",language:void 0}})();